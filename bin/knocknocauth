#!/bin/sh

usage="usage: knocknocauth [-c] host ..."

jsonheader="Content-Type: application/json"

args=`getopt c $*`
if test $? -ne 0
then
	echo "$usage" >&2
	exit 2
fi
set -- $args
while test $# -ne 0
do
	case "$1"
	in
		-c)
			close="$1"; shift;;
		--)
			shift; break;;
	esac
done

if test "$#" -eq 0
then
	echo "$usage" >&2
	exit 2
fi

configdir="$HOME/.config/knocknoc"

cachedir="$HOME/.cache/knocknoc"
mkdir -p "$cachedir"

for host in $@
do
	if test "$close"
	then
		if ! test -f "$cachedir/$host"
		then
			echo "no session cookie for $host" >&2
			continue
		fi
		echo "closing sessions not implemented yet"
		exit 1
		# curl -v -X POST -b "$cachedir/$host" "https://$host/logout"
		continue
	fi

	if test -f "$configdir/$host"
	then
		file="$configdir/$host"
		username=`sed -n 1p $file`
		password=`sed -n 2p $file`
	else
		# read in bash(1)
		# read -p "$host username: " username
		# read -p "$username's password: " password
		# for read on ksh(1) e.g. OpenBSD
		read username?"$host username: "
		read password?"$username's password: "
	fi
	body="{\"UserName\": \"$username\", \"Password\": \"$password\"}"
	curl -s -H "$jsonheader" -d "$body" -c "$cachedir/$host" "https://$host/login"
done
